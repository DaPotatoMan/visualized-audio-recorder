function u(...t){if(!(t==null?void 0:t.length))throw new Error("No stream was passed");t.forEach(e=>e.getTracks().forEach(r=>{r.stop(),r.dispatchEvent(new Event("ended")),e.removeTrack(r),e.dispatchEvent(new Event("removetrack"))}))}function v(t){return navigator.mediaDevices.getUserMedia(t)}function y(t,e){let[r]=t.getAudioTracks(),i=new MediaStream([r]),o=new AudioContext,n=o.createMediaStreamSource(i),a=o.createMediaStreamDestination(),d=o.createGain();d.gain.value=e,[n,d,a].reduce((m,h)=>m&&m.connect(h));let[s]=a.stream.getAudioTracks();return t.removeTrack(r),t.addTrack(s),()=>{u(t),u(i),u(a.stream),a.disconnect(),n.disconnect(),o.state!=="closed"&&o.close()}}function M(t,e){return t.getAudioTracks().forEach(r=>e.addTrack(r)),e}function w(t,e){t.getTracks().forEach(r=>r.contentHint=e)}import x from"array-smooth";var c={lineCap:"round",gap:5,lineWidth:10,maxLines:40,bufferSize:512};function b(t,e,r){let i=x(r,4),{gap:o,lineCap:n,lineWidth:a}=c,{width:d,height:s}=t;Object.assign(e,{lineWidth:a,lineCap:n}),e.clearRect(0,0,d,s),e.fillStyle="#09070D",e.fillRect(0,0,d,s),e.strokeStyle="#fff",i.forEach((m,h)=>{let S=Math.min(Math.max(m,0),s/3),f=o*(h+1);f>d-o||(e.beginPath(),e.moveTo(f,s/2+S),e.lineTo(f,s/2-S),e.stroke())})}async function C(t,e,r){try{let s=function(){!d||(requestAnimationFrame(s),o.getByteFrequencyData(a),b(t,e,a))};c.lineWidth=Math.round(t.width/130),c.gap=Math.round(t.width/(c.lineWidth*2)),c.maxLines=Math.round(t.width/(c.gap-c.lineWidth)),console.log(c);let i=new AudioContext,o=i.createAnalyser();o.fftSize=c.bufferSize,o.minDecibels=-90,o.maxDecibels=20,o.smoothingTimeConstant=.85,i.createMediaStreamSource(r).connect(o);let a=new Uint8Array(o.frequencyBinCount).slice(0,c.maxLines),d=!0;r.addEventListener("removetrack",()=>{console.info("Stopping canvas drawing"),e.clearRect(0,0,t.width,t.height),d=!1}),requestAnimationFrame(s)}catch(i){console.error(i)}}function T(t,e){let r=document.createElement("canvas"),i=16/9,o=720;r.width=o*i,r.height=o;let n=r.getContext("2d");C(r,n,t);let a=r.captureStream(e);return w(a,"detail"),a}var k={constraints:{audio:{autoGainControl:!0,noiseSuppression:!0,echoCancellation:!0,suppressLocalAudioPlayback:!0}},recorder:{mimeType:"video/webm;codecs=vp9,opus"},visualizerFps:60},g=class{options=k;recorder;constructor(e){this.options=Object.assign(k,e)}async init(){var n;this.destroy();let e=await v((n=this.options)==null?void 0:n.constraints),r=T(e,this.options.visualizerFps),i=M(e,r),o=y(i,7);this.recorder=new MediaRecorder(i,this.options.recorder),this.recorder.addEventListener("stop",()=>{o(),u(i,e,r)})}start(){var e;(e=this.recorder)==null||e.start()}stop(){var e;if(((e=this.recorder)==null?void 0:e.state)!=="inactive")return new Promise(r=>{var i,o;(i=this.recorder)==null||i.addEventListener("dataavailable",n=>r(n.data)),(o=this.recorder)==null||o.stop()})}destroy(){this.recorder&&(this.recorder.stop(),this.recorder=void 0)}};export{g as default};
