function m(...r){if(!(r==null?void 0:r.length))throw new Error("No stream was passed");r.forEach(e=>e.getTracks().forEach(t=>{t.stop(),t.dispatchEvent(new Event("ended")),e.removeTrack(t),e.dispatchEvent(new Event("removetrack"))}))}function g(r){return navigator.mediaDevices.getUserMedia(r)}function S(r,e){let[t]=r.getAudioTracks(),o=new MediaStream([t]),n=new AudioContext,s=n.createMediaStreamSource(o),i=n.createMediaStreamDestination(),c=n.createGain();c.gain.value=e,[s,c,i].reduce((u,f)=>u&&u.connect(f));let[a]=i.stream.getAudioTracks();return r.removeTrack(t),r.addTrack(a),()=>{m(r),m(o),m(i.stream),i.disconnect(),s.disconnect(),n.state!=="closed"&&n.close()}}function y(r,e){return r.getAudioTracks().forEach(t=>e.addTrack(t)),e}function E(r,e){r.getTracks().forEach(t=>t.contentHint=e)}import b from"array-smooth";var d={lineCap:"round",gap:5,lineWidth:10,maxLines:40,bufferSize:512};function x(r,e,t){let o=b(t,4),{gap:n,lineCap:s,lineWidth:i}=d,{width:c,height:a}=r;Object.assign(e,{lineWidth:i,lineCap:s}),e.clearRect(0,0,c,a),e.fillStyle="#09070D",e.fillRect(0,0,c,a),e.strokeStyle="#fff",o.forEach((u,f)=>{let M=Math.min(Math.max(u,0),a/3),l=n*(f+1);l>c-n||(e.beginPath(),e.moveTo(l,a/2+M),e.lineTo(l,a/2-M),e.stroke())})}async function w(r,e,t){try{let a=function(){!c||(requestAnimationFrame(a),n.getByteFrequencyData(i),x(r,e,i))};d.lineWidth=Math.round(r.width/130),d.gap=Math.round(r.width/(d.lineWidth*2)),d.maxLines=Math.round(r.width/(d.gap-d.lineWidth));let o=new AudioContext,n=o.createAnalyser();n.fftSize=d.bufferSize,n.minDecibels=-90,n.maxDecibels=20,n.smoothingTimeConstant=.85;let s=t.clone();o.createMediaStreamSource(s).connect(n);let i=new Uint8Array(n.frequencyBinCount).slice(0,d.maxLines),c=!0;t.addEventListener("removetrack",()=>{m(s),console.info("Stopping canvas drawing"),e.clearRect(0,0,r.width,r.height),c=!1}),requestAnimationFrame(a)}catch(o){console.error(o)}}function T(r,e){let t=document.createElement("canvas");if(!(t==null?void 0:t.captureStream))throw new Error("This browser does not support captureStream");let o=16/9,n=720;t.width=n*o,t.height=n;let s=t.getContext("2d");w(t,s,r);let i=t.captureStream(e);return E(i,"detail"),i}var k={constraints:{audio:!0},fps:24},v=class{options=k;recorder;chunks=[];constructor(e){this.options=Object.assign(k,e)}async init(){this.destroy();let{constraints:e,recorder:t,amplify:o,fps:n}=this.options,s=await g(e),i=T(s,n),c=y(s,i),a;o&&o>1&&(a=S(c,o)),this.recorder=new MediaRecorder(c,t),this.recorder.addEventListener("stop",()=>{m(c,s,i),a==null||a()}),this.recorder.addEventListener("dataavailable",u=>u.data.size>0&&this.chunks.push(u.data))}start(){var e;(e=this.recorder)==null||e.start()}stop(){let e=this.recorder;if(!(!e||(e==null?void 0:e.state)==="inactive"))return new Promise(t=>{e.addEventListener("stop",()=>{let o=new Blob(this.chunks,{type:e.mimeType});t(o)}),e.stop()})}destroy(){this.recorder&&(this.recorder.stop(),this.recorder=void 0),this.chunks=[]}on(e,t,o){var n;(n=this.recorder)==null||n.addEventListener(e,t,o)}off(e,t,o){var n;(n=this.recorder)==null||n.removeEventListener(e,t,o)}emit(e){var t;(t=this.recorder)==null||t.dispatchEvent(new Event(e))}};export{v as default};
